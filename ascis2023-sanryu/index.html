<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>ASCIS 2023 - Sanryu (REV) - FazeCT Blogs</title><meta name=Description content="Solutions to the challenge Sanryu in ASCIS 2023."><meta property="og:title" content="ASCIS 2023 - Sanryu (REV)"><meta property="og:description" content="Solutions to the challenge Sanryu in ASCIS 2023."><meta property="og:type" content="article"><meta property="og:url" content="https://fazect.github.io/ascis2023-sanryu/"><meta property="og:image" content="https://fazect.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-30T02:35:00+07:00"><meta property="article:modified_time" content="2023-10-30T02:35:00+07:00"><meta property="og:site_name" content="FazeCT blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fazect.github.io/logo.png"><meta name=twitter:title content="ASCIS 2023 - Sanryu (REV)"><meta name=twitter:description content="Solutions to the challenge Sanryu in ASCIS 2023."><meta name=application-name content="CTF Blogs"><meta name=apple-mobile-web-app-title content="CTF Blogs"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://fazect.github.io/ascis2023-sanryu/><link rel=prev href=https://fazect.github.io/sekaictf2023-sfc/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"ASCIS 2023 - Sanryu (REV)","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/fazect.github.io\/ascis2023-sanryu\/"},"genre":"posts","keywords":"RE, ASCIS, english","wordcount":2801,"url":"https:\/\/fazect.github.io\/ascis2023-sanryu\/","datePublished":"2023-10-30T02:35:00+07:00","dateModified":"2023-10-30T02:35:00+07:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"FazeCT"},"description":"Solutions to the challenge Sanryu in ASCIS 2023."}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="FazeCT Blogs">Blogs</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/aboutme/>About Me </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="FazeCT Blogs">Blogs</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/aboutme/ title>About Me</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">ASCIS 2023 - Sanryu (REV)</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://fazect.github.io title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>FazeCT</a>
</span>&nbsp;<span class=post-category>included in <a href=/categories/writeups/><i class="far fa-folder fa-fw" aria-hidden=true></i>Writeups</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-10-30>2023-10-30</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2801 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;14 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#challenge-information>Challenge Information</a></li><li><a href=#main-binary>Main binary</a></li><li><a href=#challenge-3>Challenge 3</a></li><li><a href=#challenge-2>Challenge 2</a></li><li><a href=#challenge-1>Challenge 1</a></li></ul></nav></div></div><div class=content id=content><p>Solutions to the challenge Sanryu in ASCIS 2023.</p><h2 id=overview>Overview</h2><p>Last weekend, I participated in ASEAN Students Contest on Information Security (ASCIS) with my university team, and we secured one slot in the Finals. Although the Final round will be re-organized soon due to some technical difficulties in Attack & Defense, we ended our day by being the only solver of a Reverse Engineering challenge named <code>Sanryu</code>, in the final seconds of the CTF.</p><h2 id=challenge-information>Challenge Information</h2><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Challenge Information<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ul><li><strong>Challenge name:</strong> Sanryu</li><li><strong>Given file:</strong> <a href="https://drive.google.com/file/d/1wNw1lxfqTNM8-n1_56lBSkiHSER2hhFV/view?usp=sharing" target=_blank rel="noopener noreffer">Get it here!</a></li></ul></div></div></div><h2 id=main-binary>Main binary</h2><p>We are given a DotNet executable to work with. Running the binary prompts us an image of the hydra meme.</p><img src=lmao.png alt width=1000><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C# data-lang=C#><span class=line><span class=cl><span class=kd>private</span> <span class=k>void</span> <span class=n>pictureBox1_MouseUp</span><span class=p>(</span><span class=kt>object</span> <span class=n>sender</span><span class=p>,</span> <span class=n>EventArgs</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Cursor</span> <span class=n>cursor</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Cursor</span><span class=p>(</span><span class=n>Resources</span><span class=p>.</span><span class=n>sword_up</span><span class=p>.</span><span class=n>Handle</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=n>pictureBox1</span><span class=p>.</span><span class=n>Cursor</span> <span class=p>=</span> <span class=n>cursor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Point</span> <span class=n>location</span> <span class=p>=</span> <span class=p>((</span><span class=n>MouseEventArgs</span><span class=p>)</span><span class=n>e</span><span class=p>).</span><span class=n>Location</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>location</span><span class=p>.</span><span class=n>X</span> <span class=p>&gt;</span> <span class=m>8</span> <span class=p>&amp;&amp;</span> <span class=n>location</span><span class=p>.</span><span class=n>X</span> <span class=p>&lt;</span> <span class=m>157</span> <span class=p>&amp;&amp;</span> <span class=n>location</span><span class=p>.</span><span class=n>Y</span> <span class=p>&gt;</span> <span class=m>117</span> <span class=p>&amp;&amp;</span> <span class=n>location</span><span class=p>.</span><span class=n>Y</span> <span class=p>&lt;</span> <span class=m>429</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>runResource</span><span class=p>(</span><span class=s>&#34;challenge_1.exe&#34;</span><span class=p>,</span> <span class=n>Resources</span><span class=p>.</span><span class=n>challenge_1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>location</span><span class=p>.</span><span class=n>X</span> <span class=p>&gt;</span> <span class=m>203</span> <span class=p>&amp;&amp;</span> <span class=n>location</span><span class=p>.</span><span class=n>X</span> <span class=p>&lt;</span> <span class=m>314</span> <span class=p>&amp;&amp;</span> <span class=n>location</span><span class=p>.</span><span class=n>Y</span> <span class=p>&gt;</span> <span class=m>88</span> <span class=p>&amp;&amp;</span> <span class=n>location</span><span class=p>.</span><span class=n>Y</span> <span class=p>&lt;</span> <span class=m>434</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>runResource</span><span class=p>(</span><span class=s>&#34;challenge_2.exe&#34;</span><span class=p>,</span> <span class=n>Resources</span><span class=p>.</span><span class=n>challenge_2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>location</span><span class=p>.</span><span class=n>X</span> <span class=p>&gt;</span> <span class=m>368</span> <span class=p>&amp;&amp;</span> <span class=n>location</span><span class=p>.</span><span class=n>Y</span> <span class=p>&lt;</span> <span class=m>494</span> <span class=p>&amp;&amp;</span> <span class=n>location</span><span class=p>.</span><span class=n>Y</span> <span class=p>&gt;</span> <span class=m>138</span> <span class=p>&amp;&amp;</span> <span class=n>location</span><span class=p>.</span><span class=n>Y</span> <span class=p>&lt;</span> <span class=m>430</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>runResource</span><span class=p>(</span><span class=s>&#34;challenge_3.exe&#34;</span><span class=p>,</span> <span class=n>Resources</span><span class=p>.</span><span class=n>challenge_3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>From the decompiled code, we can see that when you click on each of the three heads of the hydra, a different binary will be run. I used dnspy&rsquo;s debugger to quickly dump out the 3 binaries.</p><p>The meme also implies that the third challenge should be the easiest to solve, so I will start from it.</p><h2 id=challenge-3>Challenge 3</h2><p>I used IDA to analyze the binary. At first glance, it does look simple with just about 20 lines of encryption.</p><img src=chall3.png alt width=1000><p>The program prompts us for an input, that input will go through a simple ROL cipher.</p><p>I debugged to get the values, and quickly wrote a script to solve it. The general idea is to modulo the value by <code>8</code> (because each character is <code>1</code> byte) to minimize the time taken.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Py data-lang=Py><span class=line><span class=cl><span class=k>def</span> <span class=nf>rol</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>tmp</span> <span class=o>=</span> <span class=nb>bin</span><span class=p>(</span><span class=n>a</span><span class=p>)[</span><span class=mi>2</span><span class=p>:]</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=s1>&#39;0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>tmp</span><span class=p>[</span><span class=n>x</span><span class=p>:]</span> <span class=o>+</span> <span class=n>tmp</span><span class=p>[:</span><span class=n>x</span><span class=p>],</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=p>[</span><span class=mh>0xD7</span><span class=p>,</span> <span class=mh>0x9E</span><span class=p>,</span> <span class=mh>0xCA</span><span class=p>,</span> <span class=mh>0x51</span><span class=p>,</span> <span class=mh>0xA4</span><span class=p>,</span> <span class=mh>0xEB</span><span class=p>,</span> <span class=mh>0x8A</span><span class=p>,</span> <span class=mh>0x48</span><span class=p>,</span> <span class=mh>0x2B</span><span class=p>,</span> <span class=mh>0xBE</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>  <span class=mh>0x62</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x96</span><span class=p>,</span> <span class=mh>0x2B</span><span class=p>,</span> <span class=mh>0xD7</span><span class=p>,</span> <span class=mh>0x11</span><span class=p>,</span> <span class=mh>0xDB</span><span class=p>,</span> <span class=mh>0x63</span><span class=p>,</span> <span class=mh>0xFA</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ls</span> <span class=o>=</span> <span class=p>[</span><span class=mh>0xf3a8d24e</span><span class=p>,</span> <span class=mh>0x57286251</span><span class=p>,</span> <span class=mh>0xed0bb215</span><span class=p>,</span> <span class=mh>0xc54297c6</span><span class=p>,</span> <span class=mh>0x1372d3d1</span><span class=p>,</span> <span class=mh>0x9aebb2fd</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=mh>0x4074858d</span><span class=p>,</span> <span class=mh>0xd8f50000</span><span class=p>,</span> <span class=mh>0x95e8f163</span><span class=p>,</span> <span class=mh>0x325640e9</span><span class=p>,</span> <span class=mh>0x6c750331</span><span class=p>,</span> <span class=mh>0x86a54774</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=mh>0xd88dda56</span><span class=p>,</span> <span class=mh>0xfbd660c5</span><span class=p>,</span> <span class=mh>0x77f412ae</span><span class=p>,</span> <span class=mh>0x9077a73e</span><span class=p>,</span> <span class=mh>0xb8817c4e</span><span class=p>,</span> <span class=mh>0xb4a4110c</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=mh>0xbc4e8a99</span><span class=p>,</span> <span class=mh>0x409d7713</span><span class=p>,</span> <span class=mh>0x935c8213</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>min</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>ls</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>))):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>end</span><span class=o>=</span><span class=nb>chr</span><span class=p>(</span><span class=n>rol</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=mi>8</span> <span class=o>-</span> <span class=p>(</span><span class=n>ls</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>%</span> <span class=mi>8</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># _OVER_THe_1@ZY_Do6}</span>
</span></span></code></pre></td></tr></table></div></div><p>Okay, this gives us the third part of the flag. Let&rsquo;s move on to the next challenge.</p><h2 id=challenge-2>Challenge 2</h2><p>I also used IDA on this binary, and it does look more complicated than the previous one. A quick static analysis on the main function gave me this result.</p><img src=chall2.png alt width=1000><p>The check function compares our input with the XOR-decoded value being stored in the memory.</p><img src=chall2_2.png alt width=1000><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Py data-lang=Py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=n>xor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>xor</span><span class=p>([</span><span class=mh>0x7D</span><span class=p>,</span> <span class=mh>0x7E</span><span class=p>,</span> <span class=mh>0xB3</span><span class=p>,</span> <span class=mh>0x90</span><span class=p>,</span> <span class=mh>0xF9</span><span class=p>,</span> <span class=mh>0x15</span><span class=p>,</span> <span class=mh>0xBA</span><span class=p>,</span> <span class=mh>0xA7</span><span class=p>,</span> <span class=mh>0x72</span><span class=p>,</span> <span class=mh>0x68</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>  <span class=mh>0xA7</span><span class=p>,</span> <span class=mh>0x97</span><span class=p>,</span> <span class=mh>0xF6</span><span class=p>,</span> <span class=mh>0x62</span><span class=p>,</span> <span class=mh>0xB7</span><span class=p>,</span> <span class=mh>0xC1</span><span class=p>,</span> <span class=mh>0x7E</span><span class=p>,</span> <span class=mh>0x66</span><span class=p>,</span> <span class=mh>0xB3</span><span class=p>,</span> <span class=mh>0x98</span><span class=p>,</span> <span class=mh>0xF0</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>,</span> <span class=mh>0xB9</span><span class=p>,</span> <span class=mh>0xC9</span><span class=p>,</span> <span class=mh>0x71</span><span class=p>,</span> <span class=mh>0x76</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>  <span class=mh>0xAA</span><span class=p>,</span> <span class=mh>0xED</span><span class=p>,</span> <span class=mh>0xF4</span><span class=p>,</span> <span class=mh>0x1B</span><span class=p>,</span> <span class=mh>0xB7</span><span class=p>,</span> <span class=mh>0xD6</span><span class=p>],</span> <span class=p>[</span><span class=mh>0x27</span><span class=p>,</span> <span class=mh>0x2F</span><span class=p>,</span> <span class=mh>0xFF</span><span class=p>,</span> <span class=mh>0xDF</span><span class=p>,</span> <span class=mh>0xBD</span><span class=p>,</span> <span class=mh>0x57</span><span class=p>,</span> <span class=mh>0xE3</span><span class=p>,</span> <span class=mh>0x93</span><span class=p>,</span> <span class=mh>0x27</span><span class=p>,</span> <span class=mh>0x2F</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>  <span class=mh>0xFF</span><span class=p>,</span> <span class=mh>0xDF</span><span class=p>,</span> <span class=mh>0xBD</span><span class=p>,</span> <span class=mh>0x57</span><span class=p>,</span> <span class=mh>0xE3</span><span class=p>,</span> <span class=mh>0x93</span><span class=p>]))</span>
</span></span></code></pre></td></tr></table></div></div><p>A quick script gave <code>ZQLODBY4UGXHK5TRYILGMEZZVYU2ILTE</code> as the result. I tried it on the binary but it gave nothing.</p><p>I tried to decrypt the image by myself (it uses RC4 to encrypt the image), but I got this.</p><img src=susflag.jpg alt width=1000><p>Okay, something really squishy here. I went back to recheck the code flow and I saw the assembly part where the binary does <code>call 0FFFFFFFFFFFFFFFF</code> in the <code>check()</code> function. That surely gives Exception when you run it. I did some further static analysis until I saw that the function to decrypt <code>RC4</code> was called twice. So I went on and check the other part that calls it.</p><p>Turns out, that part in <code>sub_140001F50()</code> is where we should look at. The binary decrypts another PE file using <code>RC4</code>, and we can actually dump it out by putting a breakpoint at the end of the <code>RC4</code> decrypt function to dump the binary out.</p><img src=chall2_3.png alt width=1000><p>The binary wants an input and it will go through the check function below.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>char</span> <span class=kr>__fastcall</span> <span class=nf>sub_180001040</span><span class=p>(</span><span class=kr>__int64</span> <span class=n>a1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>i</span><span class=p>;</span> <span class=c1>// [rsp+24h] [rbp-24h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>v3</span><span class=p>;</span> <span class=c1>// [rsp+28h] [rbp-20h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>15</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>v3</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)(</span><span class=n>a1</span> <span class=o>+</span> <span class=n>i</span><span class=p>)</span> <span class=o>+</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)(</span><span class=n>byte_180004048</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^</span> <span class=nf>sub_180001000</span><span class=p>(</span><span class=n>byte_180004048</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=mi>2</span><span class=p>)</span> <span class=o>^</span> <span class=n>v3</span><span class=p>)</span> <span class=o>!=</span> <span class=n>byte_180004038</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>It was relatively easy to solve, so I will just give out my script below.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Py data-lang=Py><span class=line><span class=cl><span class=k>def</span> <span class=nf>enc</span><span class=p>(</span><span class=n>a1</span><span class=p>,</span> <span class=n>a2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>((</span><span class=n>a1</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=mi>8</span> <span class=o>-</span> <span class=n>a2</span><span class=p>))</span> <span class=o>|</span> <span class=p>(</span><span class=n>a1</span> <span class=o>&gt;&gt;</span> <span class=n>a2</span><span class=p>))</span> <span class=o>&amp;</span> <span class=mh>0xFF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=p>[</span><span class=mh>0xDC</span><span class=p>,</span> <span class=mh>0x3C</span><span class=p>,</span> <span class=mh>0x0A</span><span class=p>,</span> <span class=mh>0xBE</span><span class=p>,</span> <span class=mh>0x75</span><span class=p>,</span> <span class=mh>0xCB</span><span class=p>,</span> <span class=mh>0x0A</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0xF4</span><span class=p>,</span> <span class=mh>0x4A</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>  <span class=mh>0x8C</span><span class=p>,</span> <span class=mh>0x86</span><span class=p>,</span> <span class=mh>0xAA</span><span class=p>,</span> <span class=mh>0xE4</span><span class=p>,</span> <span class=mh>0xC3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>b</span> <span class=o>=</span> <span class=p>[</span><span class=mh>0xA7</span><span class=p>,</span> <span class=mh>0x4F</span><span class=p>,</span> <span class=mh>0xB2</span><span class=p>,</span> <span class=mh>0x70</span><span class=p>,</span> <span class=mh>0x70</span><span class=p>,</span> <span class=mh>0x50</span><span class=p>,</span> <span class=mh>0xD8</span><span class=p>,</span> <span class=mh>0xF9</span><span class=p>,</span> <span class=mh>0xAB</span><span class=p>,</span> <span class=mh>0xB1</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>  <span class=mh>0xFB</span><span class=p>,</span> <span class=mh>0x78</span><span class=p>,</span> <span class=mh>0x77</span><span class=p>,</span> <span class=mh>0x87</span><span class=p>,</span> <span class=mh>0x1D</span><span class=p>,</span> <span class=mh>0xC3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>15</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=mi>127</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>=</span> <span class=n>j</span> <span class=o>+</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^</span> <span class=n>enc</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=mi>2</span><span class=p>)</span> <span class=o>^</span> <span class=n>c</span> <span class=o>==</span> <span class=n>b</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>end</span><span class=o>=</span><span class=nb>chr</span><span class=p>(</span><span class=n>j</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl><span class=c1># Br0WN_FOX_JUmP$</span>
</span></span></code></pre></td></tr></table></div></div><p>So we have our second part of the flag, it&rsquo;s time to move on to the last one.</p><h2 id=challenge-1>Challenge 1</h2><p>I consider this one to be the hardest. The binary is actually nanomites, where there are 2 parallel process communicating with each other. I debugged each of them individually by patching the mutex check to debug the child process.</p><p>In general, the parent process wants an input from us, then it is sent to the child process by the second value of the argv. The processes communicate with each other using functions like <code>WaitForDebugEvent</code>, <code>GetThreadContext</code>, &mldr; and through registers, like how a nanomites related challenge should work. Each time the child process encounter an <code>int 3</code> call, the parent process continues, and the parent process - having finished its job, the <code>eip</code> is changed and the flow returns to the child process and so on.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span> <span class=nf>OpenMutexA</span><span class=p>(</span><span class=mh>0x100000u</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;ASCIS_2023&#34;</span><span class=p>)</span> <span class=p>)</span> <span class=c1>// Patched this for child process debugging later.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>parentProc</span><span class=p>();</span> <span class=c1>// Parent process
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>2</span> <span class=p>)</span> <span class=c1>// Child process
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>v16</span> <span class=o>=</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>v10</span> <span class=o>=</span> <span class=n>v16</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v17</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v16</span><span class=p>[</span><span class=nf>strlen</span><span class=p>(</span><span class=n>v16</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>v19</span> <span class=o>=</span> <span class=nf>malloc</span><span class=p>(</span><span class=nf>__CFADD__</span><span class=p>(</span><span class=n>v17</span> <span class=o>-</span> <span class=p>(</span><span class=n>_DWORD</span><span class=p>)</span><span class=n>v10</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>?</span> <span class=o>-</span><span class=mi>1</span> <span class=o>:</span> <span class=n>v17</span> <span class=o>-</span> <span class=p>(</span><span class=n>_DWORD</span><span class=p>)</span><span class=n>v10</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>v14</span> <span class=o>=</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>v9</span> <span class=o>=</span> <span class=n>v14</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v15</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v14</span><span class=p>[</span><span class=nf>strlen</span><span class=p>(</span><span class=n>v14</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=n>v19</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>v15</span> <span class=o>-</span> <span class=p>(</span><span class=n>_DWORD</span><span class=p>)</span><span class=n>v9</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>v12</span> <span class=o>=</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>v8</span> <span class=o>=</span> <span class=n>v12</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v13</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v12</span><span class=p>[</span><span class=nf>strlen</span><span class=p>(</span><span class=n>v12</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nf>memmove</span><span class=p>(</span><span class=n>v19</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>v13</span> <span class=o>-</span> <span class=p>(</span><span class=n>_DWORD</span><span class=p>)</span><span class=n>v8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=nf>sub_B81120</span><span class=p>(</span><span class=n>v20</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>v3</span> <span class=o>=</span> <span class=nf>sub_B83190</span><span class=p>((</span><span class=kt>void</span> <span class=o>**</span><span class=p>)</span><span class=n>v20</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=s>&#34;checkFormat&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=p>((</span><span class=kt>int</span> <span class=p>(</span><span class=kr>__stdcall</span> <span class=o>*</span><span class=p>)(</span><span class=kt>void</span> <span class=o>*</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=n>_DWORD</span><span class=p>,</span> <span class=n>_DWORD</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=kt>int</span><span class=p>))</span><span class=n>v3</span><span class=p>)(</span>
</span></span><span class=line><span class=cl>                 <span class=n>v19</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v13</span> <span class=o>-</span> <span class=p>(</span><span class=n>_DWORD</span><span class=p>)</span><span class=n>v8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v15</span> <span class=o>-</span> <span class=p>(</span><span class=n>_DWORD</span><span class=p>)</span><span class=n>v9</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v9</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v17</span> <span class=o>-</span> <span class=p>(</span><span class=n>_DWORD</span><span class=p>)</span><span class=n>v10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v11</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v13</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v15</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v17</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v18</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v19</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>v20</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                 <span class=n>v20</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>      <span class=nf>__debugbreak</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Above is the main flow of the child process of the nanomites.</p><p>I debugged into the function stored in <code>v3</code> variable and figured out that it was used to check the format of the input from the parent process.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>BOOL</span> <span class=kr>__cdecl</span> <span class=nf>sub_10001000</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=n>a1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>v1</span><span class=p>;</span> <span class=c1>// edx
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>_BYTE</span> <span class=o>*</span><span class=n>v2</span><span class=p>;</span> <span class=c1>// esi
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v3</span><span class=p>;</span> <span class=c1>// edi
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>v4</span><span class=p>;</span> <span class=c1>// cl
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>v5</span><span class=p>;</span> <span class=c1>// bl
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>v6</span><span class=p>;</span> <span class=c1>// ch
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v7</span><span class=p>;</span> <span class=c1>// eax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>_BYTE</span> <span class=o>*</span><span class=n>v8</span><span class=p>;</span> <span class=c1>// esi
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v9</span><span class=p>;</span> <span class=c1>// eax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>__int128</span> <span class=n>v11</span><span class=p>;</span> <span class=c1>// [esp+0h] [ebp-14h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>v1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v2</span> <span class=o>=</span> <span class=n>a1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v3</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v11</span> <span class=o>=</span> <span class=n>xmmword_100020A0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v4</span> <span class=o>=</span> <span class=o>*</span><span class=n>a1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=o>!*</span><span class=n>a1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v5</span> <span class=o>=</span> <span class=o>*</span><span class=n>a1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>v6</span> <span class=o>=</span> <span class=n>v5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>v5</span> <span class=o>==</span> <span class=mi>10</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v5</span> <span class=o>=</span> <span class=n>v2</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>v7</span> <span class=o>=</span> <span class=n>v3</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>++</span><span class=n>v2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>v6</span> <span class=o>!=</span> <span class=mi>45</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>v7</span> <span class=o>=</span> <span class=n>v3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v3</span> <span class=o>=</span> <span class=n>v7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span> <span class=n>v5</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>v8</span> <span class=o>=</span> <span class=n>a1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>v3</span> <span class=o>!=</span> <span class=mi>3</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v9</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>v4</span> <span class=o>==</span> <span class=mi>10</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>v4</span> <span class=o>==</span> <span class=mi>45</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=o>*</span><span class=p>((</span><span class=n>_DWORD</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v11</span> <span class=o>+</span> <span class=n>v1</span><span class=p>)</span> <span class=o>!=</span> <span class=n>v9</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=o>++</span><span class=n>v1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>v9</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=o>++</span><span class=n>v9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>v4</span> <span class=o>=</span> <span class=o>*++</span><span class=n>v8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span> <span class=n>v4</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=o>*</span><span class=p>((</span><span class=n>_DWORD</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v11</span> <span class=o>+</span> <span class=n>v1</span><span class=p>)</span> <span class=o>==</span> <span class=n>v9</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The format of the license is <code>X-XXXX-XX-XXX</code> according to the function.</p><img src=image.png alt width=1000><p>These will be the part that does some magic on our input, then the flow will be changed to the parent process to do some comparisons. The key for the flag image decryption will be modified throughout the flow.</p><p>Analyze the first part and the function <code>sub_401C50()</code>, we can see that this does some kind of encryption based on the system time.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=kr>__stdcall</span> <span class=nf>sub_401C50</span><span class=p>(</span><span class=kt>char</span> <span class=n>a1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>_DWORD</span> <span class=o>*</span><span class=n>v2</span><span class=p>;</span> <span class=c1>// [esp+8h] [ebp-24h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>HANDLE</span> <span class=n>hFile</span><span class=p>;</span> <span class=c1>// [esp+Ch] [ebp-20h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>HANDLE</span> <span class=n>hFilea</span><span class=p>;</span> <span class=c1>// [esp+Ch] [ebp-20h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>CHAR</span> <span class=o>*</span><span class=n>lpBuffer</span><span class=p>;</span> <span class=c1>// [esp+10h] [ebp-1Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v6</span><span class=p>;</span> <span class=c1>// [esp+14h] [ebp-18h] BYREF
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>Buffer</span><span class=p>[</span><span class=mi>11</span><span class=p>];</span> <span class=c1>// [esp+1Ch] [ebp-10h] BYREF
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kr>__int8</span> <span class=n>v8</span><span class=p>;</span> <span class=c1>// [esp+27h] [ebp-5h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>v2</span> <span class=o>=</span> <span class=nf>VirtualAlloc</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0xAu</span><span class=p>,</span> <span class=mh>0x1000u</span><span class=p>,</span> <span class=mh>0x40u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>getTime</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>Buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>lpBuffer</span> <span class=o>=</span> <span class=p>(</span><span class=n>CHAR</span> <span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=mh>0x1000u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>GetEnvironmentVariableA</span><span class=p>(</span><span class=s>&#34;temp&#34;</span><span class=p>,</span> <span class=n>lpBuffer</span><span class=p>,</span> <span class=mh>0x1000u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>sub_401280</span><span class=p>(</span><span class=n>lpBuffer</span><span class=p>,</span> <span class=s>&#34;%s</span><span class=se>\\</span><span class=s>pointer.time&#34;</span><span class=p>,</span> <span class=n>lpBuffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>hFile</span> <span class=o>=</span> <span class=nf>CreateFileA</span><span class=p>(</span><span class=n>lpBuffer</span><span class=p>,</span> <span class=mh>0x40000000u</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1u</span><span class=p>,</span> <span class=mh>0x80u</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=nf>GetLastError</span><span class=p>()</span> <span class=o>==</span> <span class=mi>80</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>hFilea</span> <span class=o>=</span> <span class=nf>CreateFileA</span><span class=p>(</span><span class=n>lpBuffer</span><span class=p>,</span> <span class=mh>0x80000000</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3u</span><span class=p>,</span> <span class=mh>0x80u</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>ReadFile</span><span class=p>(</span><span class=n>hFilea</span><span class=p>,</span> <span class=n>Buffer</span><span class=p>,</span> <span class=mi>8u</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>WriteFile</span><span class=p>(</span><span class=n>hFile</span><span class=p>,</span> <span class=n>Buffer</span><span class=p>,</span> <span class=mi>8u</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>getTime</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>v8</span> <span class=o>=</span> <span class=n>a1</span> <span class=o>^</span> <span class=p>(</span><span class=n>v6</span> <span class=o>-</span> <span class=n>Buffer</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=n>v2</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v2</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>((</span><span class=n>_WORD</span> <span class=o>*</span><span class=p>)</span><span class=n>v2</span> <span class=o>+</span> <span class=mi>4</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)</span><span class=n>v2</span> <span class=o>=</span> <span class=n>v8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=kr>__cdecl</span> <span class=o>*</span><span class=p>)(</span><span class=n>_DWORD</span> <span class=o>*</span><span class=p>))</span><span class=n>v2</span><span class=p>)(</span><span class=n>v2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>v8</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>I debugged and got to know the function <code>getTime()</code> was called twice to get the time at two different moment.</p><p>The variable <code>v8</code> contains the difference between the two results gathered from <code>getTime()</code>, XORed with <code>a1</code>, which is our input character for the first part of the license.</p><p>It puts the value of <code>v8</code> into <code>v2</code>, then call <code>v2()</code> like a shellcode. This reminds me of the <code>4th</code> challenge from last year <code>Flare-On 9th</code>, where we have to make it calls <code>ret</code>, so that the program will continue to run normally.</p><p>From that, we can conclude that our input for the first part should equal to the difference of the time that I mentioned above XORed with <code>0xC3</code> - the hex value of <code>ret</code>. To easily bypass this, I patched this function, so that we can input anything we want, but it still gives <code>0xC3</code>.</p><p>Move on to the second part (I modified the <code>eip</code> register while debugging the child process to get pass the <code>int 3</code> calls to get to the second part check, because before each check function will be another function that loads them in), I can see that the function being called at <code>0xB81F4D</code> actually separates the first part out.</p><p>After that we are left with <code>XXXX-XX-XXX</code>, then the first character will be compared with <code>1</code>, which means we have <code>1XXX-XX-XXX</code>.</p><p>The function being called at <code>0xB81F82</code> is the checker for the second part of the license. Further debugging inside it reveals the flow, as below.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>debug035:100010E7 mov     al, [edi+2]
</span></span><span class=line><span class=cl>debug035:100010EA xor     al, [edi+1]
</span></span><span class=line><span class=cl>debug035:100010ED mov     byte ptr [ebp+arg_0+3], al
</span></span><span class=line><span class=cl>debug035:100010F0 xor     ebx, ebx
</span></span><span class=line><span class=cl>debug035:100010F2 mov     ebx, 3
</span></span><span class=line><span class=cl>debug035:100010F7 xor     edx, edx
</span></span><span class=line><span class=cl>debug035:100010F9 mov     dl, byte ptr [ebp+arg_0+3]
</span></span><span class=line><span class=cl>debug035:100010FC int     3                               ; Trap to Debugger
</span></span><span class=line><span class=cl>debug035:100010FD mov     eax, 0
</span></span><span class=line><span class=cl>debug035:10001102 retn
</span></span></code></pre></td></tr></table></div></div><p>With the <code>edi</code> register being the position in the second part of the license.</p><p>Below is the part after the <code>int 3</code> call (which is being looped <code>4</code> times).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=n>__usercall</span> <span class=n>sub_10001103</span><span class=err>@</span><span class=o>&lt;</span><span class=n>eax</span><span class=o>&gt;</span><span class=p>(</span><span class=kt>int</span> <span class=n>a1</span><span class=err>@</span><span class=o>&lt;</span><span class=n>ecx</span><span class=o>&gt;</span><span class=p>,</span> <span class=kt>int</span> <span class=n>a2</span><span class=err>@</span><span class=o>&lt;</span><span class=n>ebp</span><span class=o>&gt;</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>a3</span><span class=err>@</span><span class=o>&lt;</span><span class=n>edi</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>result</span><span class=p>;</span> <span class=c1>// eax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>v4</span><span class=p>;</span> <span class=c1>// al
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>v5</span><span class=p>;</span> <span class=c1>// bl
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>(</span><span class=n>_DWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>a2</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>a1</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=n>_DWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>a2</span> <span class=o>-</span> <span class=mi>4</span><span class=p>)</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=p>(</span><span class=n>_DWORD</span><span class=p>)</span><span class=n>a3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v4</span> <span class=o>=</span> <span class=o>*</span><span class=n>a3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v5</span> <span class=o>=</span> <span class=n>a3</span><span class=p>[</span><span class=mi>1</span> <span class=o>%</span> <span class=n>a1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=n>_DWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>a2</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>*</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)(</span><span class=n>a2</span> <span class=o>+</span> <span class=mi>11</span><span class=p>)</span> <span class=o>=</span> <span class=n>v4</span> <span class=o>-</span> <span class=n>v5</span> <span class=o>+</span> <span class=mi>48</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=o>*</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)(</span><span class=n>a2</span> <span class=o>+</span> <span class=mi>11</span><span class=p>)</span> <span class=o>=</span> <span class=n>v4</span> <span class=o>+</span> <span class=n>v5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>__debugbreak</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>ebx</code> this time has the value of <code>0xDEAD</code>, so we will look for that case in the parent process.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=nf>strcpy</span><span class=p>(</span><span class=n>v16</span><span class=p>,</span> <span class=s>&#34;d0j6&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=mh>0xDEADu</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=n>Eax</span> <span class=o>=</span> <span class=n>Context</span><span class=p>.</span><span class=n>Eax</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Eax</span> <span class=o>=</span> <span class=n>v16</span><span class=p>[</span><span class=n>i</span><span class=o>++</span><span class=p>]</span> <span class=o>^</span> <span class=nf>LOBYTE</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=n>Eax</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>Eax</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Context</span><span class=p>.</span><span class=n>Eip</span> <span class=o>+=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>break</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>So <code>v4</code> and <code>v5</code> contain each pair of characters in our input for the second part (it uses <code>[1 % a1]</code> to make the input <code>circular</code> - i.e. <code>a3[3]</code> with <code>a3[0]</code> are also considered to be one pair). Then based on the parity of <code>*(a2 + 8)</code>, <code>*(a2 + 11)</code> will be calculated differently, and being pulled out by <code>eax</code> register for the parent process to use.</p><p>I wrote a script to solve this part, as below.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>buf</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;1&#39;</span>
</span></span><span class=line><span class=cl><span class=n>s</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;d0j6&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>token</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>i</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>buf</span> <span class=o>+=</span> <span class=nb>bytes</span><span class=p>([</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>buf</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>buf</span> <span class=o>+=</span> <span class=nb>bytes</span><span class=p>([</span><span class=n>buf</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+</span> <span class=mh>0x30</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>buf</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=c1># 1337</span>
</span></span></code></pre></td></tr></table></div></div><p>For the third part, I changed <code>eip</code> to <code>0xB81FA4</code> for faster access, and debugged into the function being called at <code>0xB81FBC</code>. That function checks the third part.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>debug035:10001193 loc_10001193:                           ; CODE XREF: sub_10001170+2F↓j
</span></span><span class=line><span class=cl>debug035:10001193 movsx   ecx, byte ptr [esi+edi]
</span></span><span class=line><span class=cl>debug035:10001197 inc     esi
</span></span><span class=line><span class=cl>debug035:10001198 shl     edx, 8
</span></span><span class=line><span class=cl>debug035:1000119B add     edx, ecx
</span></span><span class=line><span class=cl>debug035:1000119D cmp     esi, eax
</span></span><span class=line><span class=cl>debug035:1000119F jl      short loc_10001193
</span></span><span class=line><span class=cl>debug035:100011A1 mov     [ebp+var_4], edx
</span></span><span class=line><span class=cl>debug035:100011A4
</span></span><span class=line><span class=cl>debug035:100011A4 loc_100011A4:                           ; CODE XREF: sub_10001170+21↑j
</span></span><span class=line><span class=cl>debug035:100011A4 xor     eax, eax
</span></span><span class=line><span class=cl>debug035:100011A6 xor     ebx, ebx
</span></span><span class=line><span class=cl>debug035:100011A8 mov     ebx, 0BEEFh
</span></span><span class=line><span class=cl>debug035:100011AD mov     eax, [ebp+var_4]
</span></span><span class=line><span class=cl>debug035:100011B0 xor     eax, ebx
</span></span><span class=line><span class=cl>debug035:100011B2 int     3                               ; Trap to Debugger
</span></span><span class=line><span class=cl>debug035:100011B3 mov     eax, 0
</span></span><span class=line><span class=cl>debug035:100011B8 retn
</span></span></code></pre></td></tr></table></div></div><p>The third part only has <code>2</code> characters, the second character will be stored into <code>ecx</code>, while the first one is in <code>edx</code>.</p><p>For this part, <code>[ebp+var_4]</code> will contain <code>(edx &lt;&lt; 8) + ecx</code> and <code>eax</code> will contain <code>((edx &lt;&lt; 8) + ecx) ^ 0xBEEF</code>.</p><p>The <code>ebx</code> register has the value <code>0xBEEF</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>case</span> <span class=mh>0xBEEFu</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=n>v1</span><span class=p>[</span><span class=mi>179</span><span class=p>]</span> <span class=o>=</span> <span class=n>Context</span><span class=p>.</span><span class=n>Eax</span> <span class=o>^</span> <span class=mh>0xD6A6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>Context</span><span class=p>.</span><span class=n>Eax</span> <span class=o>==</span> <span class=mh>0xD6A6</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Context</span><span class=p>.</span><span class=n>Eip</span> <span class=o>+=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>break</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>We can easily see that <code>((edx &lt;&lt; 8) + ecx) ^ 0xBEEF == 0xD6A6</code>. To solve this, I wrote this short script below.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=mi>127</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=mi>127</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=mh>0xD6A6</span> <span class=o>==</span> <span class=p>((</span><span class=n>i</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>+</span> <span class=n>j</span><span class=p>)</span> <span class=o>^</span> <span class=mh>0xBEEF</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>end</span><span class=o>=</span><span class=nb>chr</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=o>+</span> <span class=nb>chr</span><span class=p>(</span><span class=n>j</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># hI</span>
</span></span></code></pre></td></tr></table></div></div><p>The function <code>sub_B813E0()</code> will be the checker for our last part. Debugging into this function shows that <code>sub_B85D70()</code> calculates <code>sha256</code> hash of our <code>3-character-input</code> for the last part.</p><p>The hash is then compared with the long buffer in the parent process, due to the <code>ebx</code> having the value of <code>0xFEED</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.text:00B81517                 mov     ebx, 0FEEDh
</span></span><span class=line><span class=cl>.text:00B8151C                 xor     eax, eax
</span></span><span class=line><span class=cl>.text:00B8151E                 mov     eax, [ebp+var_8]
</span></span><span class=line><span class=cl>.text:00B81521                 int     3               ; Trap to Debugger
</span></span><span class=line><span class=cl>.text:00B81522                 mov     eax, 0
</span></span><span class=line><span class=cl>.text:00B81527                 retn
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>case</span> <span class=mh>0xFEEDu</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=n>v9</span> <span class=o>=</span> <span class=n>Context</span><span class=p>.</span><span class=n>Eax</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v9</span> <span class=o>=</span> <span class=n>hash</span><span class=p>[</span><span class=n>v3</span><span class=o>++</span><span class=p>]</span> <span class=o>^</span> <span class=nf>LOBYTE</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=n>Eax</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>v9</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Context</span><span class=p>.</span><span class=n>Eip</span> <span class=o>+=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>break</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>I cracked the hash and got <code>br0</code> as the result.</p><p>Combine everything together, we have <code>X-1337-hI-br0</code> as our license, with <code>X</code> being anything because we patched the first check function.</p><p>Input the license in yields us the first part of the flag.</p><img src=flag.jpg alt width=1000><p>Combine all <code>3</code> parts of the flag, we solved the challenge!</p><p>Flag is: <strong>ASCIS{ThE_quicK_Br0WN_FOX_JUmP$_OVER_THe_1@ZY_Do6}</strong></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-10-30</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/ascis2023-sanryu/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://fazect.github.io/ascis2023-sanryu/ data-title="ASCIS 2023 - Sanryu (REV)" data-hashtags=RE,ASCIS,english><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://fazect.github.io/ascis2023-sanryu/ data-hashtag=RE><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://fazect.github.io/ascis2023-sanryu/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/re/>RE</a>,&nbsp;<a href=/tags/ascis/>ASCIS</a>,&nbsp;<a href=/tags/english/>english</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/sekaictf2023-sfc/ class=prev rel=prev title="SekaiCTF 2023 - Sahuang Flag Checker"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>SekaiCTF 2023 - Sahuang Flag Checker</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.119.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://fazect.github.io/ target=_blank>FazeCT</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/plugins/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/plugins/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>